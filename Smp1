-----------------------
-- VARIABLES & SERVICES
-----------------------
local V = {
    -- Libraries
    Lib = loadstring(game:HttpGet('https://raw.githubusercontent.com/xzcReasd/scripts/refs/heads/main/LIBFIX'))(),
    Theme = loadstring(game:HttpGet('https://raw.githubusercontent.com/xzcReasd/scripts/refs/heads/main/ThemeManager'))(),
    Save = loadstring(game:HttpGet('https://raw.githubusercontent.com/xzcReasd/scripts/refs/heads/main/SaveManager'))(),
    
    -- Services
    Players = game:GetService("Players"),
    UIS = game:GetService("UserInputService"),
    RS = game:GetService("RunService"),
    WS = workspace,
    
    -- Objects
    LP = game:GetService("Players").LocalPlayer,
    Cam = workspace.CurrentCamera,
    
    -- Math/Utility
    V2 = Vector2.new,
    V3 = Vector3.new,
    CF = CFrame.new,
    math = math,
    
    -- Current target
    Target = nil,
    
    -- Highlight
    CurrentHighlight = nil
}
-- Setup libraries
V.Theme:SetLibrary(V.Lib)
V.Save:SetLibrary(V.Lib)

-- Create window
local Win = V.Lib:CreateWindow({
    Title = 'SimpleBot | Really simple | ' .. os.date('%d.%m.%Y'),
    Themeable = true,
    Info = 'SimpleBot',
    Center = true,
    AutoShow = true
})

-- Create tabs
local Tabs = {
    Aimbot = Win:AddTab('Aimbot'),
    Misc = Win:AddTab('Misc'),
    Player = Win:AddTab('Player'),
    Visuals = Win:AddTab('Visuals'),
    Config = Win:AddTab('Config')
}

-----------------------
-- CONFIG
-----------------------
local Config = {
    Aimbot = {
        Enabled = true,
        StickyKey = Enum.KeyCode.Q,
        SkipCovered = false,
        SkipKnocked = false,
        SkipGrabbed = false,
        ResetKnocked = false,
        ResetGrabbed = false,
        ResetDeath = false
    },
    TargetHighlight = {
        Enabled = false,
        OutlineColor = Color3.new(1, 0, 0),
        FillColor = Color3.new(1, 0, 0),
        OutlineTransparency = 0,
        FillTransparency = 0.5
    }
}

-----------------------
-- UTILITY FUNCTIONS
-----------------------
local function UpdateTarget(target)
    if not target then
        V.Target = nil
        return
    end

    if not target:IsA("Player") or not target.Character then
        V.Target = {
            player = target,
            name = target.Name,
            displayName = target.DisplayName or target.Name,
            character = nil,
            humanoid = nil,
            root = nil,
            r15 = nil,
            position = nil,
            cframe = nil,
            velocity = nil,
            walkspeed = nil,
            distance = nil,
            health = nil,
            maxHealth = nil,
            team = target.Team or nil,
            isAlive = false
        }
        return
    end

    if not target.Character:FindFirstChild("HumanoidRootPart") or not target.Character:FindFirstChildOfClass("Humanoid") then
        V.Target = {
            player = target,
            name = target.Name,
            displayName = target.DisplayName or target.Name,
            character = target.Character,
            humanoid = nil,
            root = nil,
            r15 = nil,
            position = nil,
            cframe = nil,
            velocity = nil,
            walkspeed = nil,
            distance = nil,
            health = nil,
            maxHealth = nil,
            team = target.Team or nil,
            isAlive = false
        }
        return
    end

    -- Build r15 parts table inline
    V.Target = {
        player = target,
        name = target.Name,
        displayName = target.DisplayName or target.Name,
        character = target.Character,
        humanoid = target.Character:FindFirstChildOfClass("Humanoid"),
        root = target.Character:FindFirstChild("HumanoidRootPart"),
        r15 = (function()
            local parts = {}
            for _, part in ipairs({"Head", "UpperTorso", "LowerTorso", "LeftUpperArm", "LeftLowerArm", "LeftHand", "RightUpperArm", "RightLowerArm", "RightHand", "LeftUpperLeg", "LeftLowerLeg", "LeftFoot", "RightUpperLeg", "RightLowerLeg", "RightFoot", "HumanoidRootPart"}) do
                local p = target.Character:FindFirstChild(part)
                if p then parts[part] = p end
            end
            return parts
        end)(),
        position = target.Character:FindFirstChild("HumanoidRootPart").Position,
        cframe = target.Character:FindFirstChild("HumanoidRootPart").CFrame,
        velocity = target.Character:FindFirstChild("HumanoidRootPart").Velocity,
        walkspeed = target.Character:FindFirstChildOfClass("Humanoid").WalkSpeed,
        distance = V.LP.Character and V.LP.Character:FindFirstChild("HumanoidRootPart") and (target.Character:FindFirstChild("HumanoidRootPart").Position - V.LP.Character:FindFirstChild("HumanoidRootPart").Position).Magnitude or 0,
        health = target.Character:FindFirstChildOfClass("Humanoid").Health,
        maxHealth = target.Character:FindFirstChildOfClass("Humanoid").MaxHealth,
        team = target.Team or nil,
        isAlive = target.Character:FindFirstChildOfClass("Humanoid").Health > 0
    }
end

local function IsVisible(targetRoot)
    if not Config.Aimbot.SkipCovered then return true end
    
    return V.WS:Raycast(V.Cam.CFrame.Position, (targetRoot.Position - V.Cam.CFrame.Position), (function()
        local params = RaycastParams.new()
        params.FilterDescendantsInstances = {V.LP.Character, targetRoot.Parent}
        params.FilterType = Enum.RaycastFilterType.Blacklist
        return params
    end)()) == nil
end

local function IsPlayerKO(player)
    return player and player.Character and player.Character:FindFirstChild("BodyEffects") and 
           player.Character.BodyEffects:FindFirstChild("K.O") and player.Character.BodyEffects["K.O"].Value and 
           (not player.Character.BodyEffects:FindFirstChild("Grabbed") or not player.Character.BodyEffects.Grabbed.Value)
end

local function IsPlayerGrabbed(player)
    return player and player.Character and player.Character:FindFirstChild("BodyEffects") and 
           player.Character.BodyEffects:FindFirstChild("Grabbed") and player.Character.BodyEffects.Grabbed.Value
end

local function GetClosestPlayerToCursor()
    local closestPlayer, shortestDistance = nil, V.math.huge

    for _, player in ipairs(V.Players:GetPlayers()) do
        if player ~= V.LP and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local screenPoint, onScreen = V.Cam:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
            if onScreen then
                local distance = (V.V2(screenPoint.X, screenPoint.Y) - V.V2(V.UIS:GetMouseLocation().X, V.UIS:GetMouseLocation().Y)).Magnitude
                if (not Config.Aimbot.SkipCovered or IsVisible(player.Character.HumanoidRootPart))
                    and (not Config.Aimbot.SkipKnocked or not IsPlayerKO(player))
                    and (not Config.Aimbot.SkipGrabbed or not IsPlayerGrabbed(player))
                    and distance < shortestDistance then
                    shortestDistance, closestPlayer = distance, player
                end
            end
        end
    end
    return closestPlayer
end

-----------------------
-- TARGET HIGHLIGHT FUNCTIONS
-----------------------

local function CreateTargetHighlight(character)
    if not character or not character:FindFirstChild('HumanoidRootPart') then return nil end
    
    local highlight = Instance.new('Highlight')
    highlight.Parent = character
    highlight.OutlineColor = Config.TargetHighlight.OutlineColor
    highlight.FillColor = Config.TargetHighlight.FillColor
    highlight.OutlineTransparency = Config.TargetHighlight.OutlineTransparency
    highlight.FillTransparency = Config.TargetHighlight.FillTransparency
    highlight.Adornee = character
    
    return highlight
end

local function UpdateTargetHighlight()
    if not Config.TargetHighlight.Enabled then
        if V.CurrentHighlight then
            V.CurrentHighlight:Destroy()
            V.CurrentHighlight = nil
        end
        return
    end
    
    if V.Target and V.Target.character then
        -- Если хайлайт уже существует, обновляем его параметры
        if V.CurrentHighlight and V.CurrentHighlight.Parent == V.Target.character then
            V.CurrentHighlight.OutlineColor = Config.TargetHighlight.OutlineColor
            V.CurrentHighlight.FillColor = Config.TargetHighlight.FillColor
            V.CurrentHighlight.OutlineTransparency = Config.TargetHighlight.OutlineTransparency
            V.CurrentHighlight.FillTransparency = Config.TargetHighlight.FillTransparency
        else
            -- Удаляем старый хайлайт если он есть
            if V.CurrentHighlight then
                V.CurrentHighlight:Destroy()
            end
            -- Создаем новый хайлайт для новой цели
            V.CurrentHighlight = CreateTargetHighlight(V.Target.character)
        end
    else
        -- Нет цели - удаляем хайлайт
        if V.CurrentHighlight then
            V.CurrentHighlight:Destroy()
            V.CurrentHighlight = nil
        end
    end
end

-----------------------
-- AIMBOT SYSTEM
-----------------------
local function OnInputBegan(input, gameProcessed)
    if not Config.Aimbot.Enabled or gameProcessed or input.KeyCode ~= Config.Aimbot.StickyKey then return end
    
    if V.Target then
        V.Target = nil
        print("Цель сброшена (вручную)")
    else
        local closest = GetClosestPlayerToCursor()
        if closest then
            UpdateTarget(closest)
            print("Выбрана цель: " .. closest.Name)
        else
            print("Не найдено подходящих целей")
        end
    end
end

-----------------------
-- AIMBOT UI
-----------------------

V.TargetBox = Tabs.Aimbot:AddLeftGroupbox('Targeting')

V.TargetBox:AddToggle('AimbotEnabled', {
    Text = 'Enabled',
    Default = true,
    Tooltip = 'Включить/выключить систему захвата цели',
    Callback = function(Value)
        Config.Aimbot.Enabled = Value
        print('[Aimbot] Targeting ' .. (Value and 'включен' or 'выключен'))
    end
})

V.TargetBox:AddLabel('Sticky Key'):AddKeyPicker('StickyKeybind', {
    Default = 'Q',
    SyncToggleState = false,
    Text = 'Sticky Target',
    NoUI = false,
    Tooltip = 'Клавиша для захвата/сброса цели',
    ChangedCallback = function(New)
        Config.Aimbot.StickyKey = (function() local kc = Enum.KeyCode[New] or Enum.KeyCode.Unknown; return kc ~= Enum.KeyCode.Unknown and (print('[Aimbot] Sticky keybind изменен на:', New) or kc) or (warn('[Aimbot] Некорректный keybind:', New) or kc) end)()
    end
})

-----------------------
-- SKIP SETTINGS UI
-----------------------

V.SkipBox = Tabs.Aimbot:AddRightGroupbox('Skip')
V.SkipBox:AddToggle('SkipCovered', {
    Text = 'Skip Covered',
    Default = false,
    Tooltip = 'Пропускать игроков, которые находятся за стеной',
    Callback = function(v)
        Config.Aimbot.SkipCovered = v
    end
})

V.SkipBox:AddToggle('SkipKnocked', {
    Text = 'Skip Knocked',
    Default = false,
    Tooltip = 'Пропускать игроков, которые в нокауте',
    Callback = function(v)
        Config.Aimbot.SkipKnocked = v
    end
})

V.SkipBox:AddToggle('SkipGrabbed', {
    Text = 'Skip Grabbed',
    Default = false,
    Tooltip = 'Пропускать игроков, которых держат',
    Callback = function(v)
        Config.Aimbot.SkipGrabbed = v
    end
})

-----------------------
-- RESET TARGET ON UI
-----------------------

V.ResetBox = Tabs.Aimbot:AddRightGroupbox('ResetTargetON')
V.ResetBox:AddToggle('ResetKnocked', {
    Text = 'Knocked',
    Default = false,
    Tooltip = 'Сбрасывать цель, если она нокаутирована',
    Callback = function(v)
        Config.Aimbot.ResetKnocked = v
    end
})
V.ResetBox:AddToggle('ResetGrabbed', {
    Text = 'Grabbed',
    Default = false,
    Tooltip = 'Сбрасывать цель, если её схватили',
    Callback = function(v)
        Config.Aimbot.ResetGrabbed = v
    end
})
V.ResetBox:AddToggle('ResetDeath', {
    Text = 'Death',
    Default = false,
    Tooltip = 'Сбрасывать цель при смерти',
    Callback = function(v)
        Config.Aimbot.ResetDeath = v
    end
})

-----------------------
-- VISUALIZATIONS UI
-----------------------

V.VisBox = Tabs.Aimbot:AddRightGroupbox('Visualizations')

V.HLToggle = V.VisBox:AddToggle('TargetHighlight', {
    Text = 'Target Highlight',
    Default = false,
    Tooltip = 'Подсвечивать выбранную цель',
    Callback = function(v)
        Config.TargetHighlight.Enabled = v
        if not v and V.CurrentHighlight then
            V.CurrentHighlight:Destroy()
            V.CurrentHighlight = nil
        end
    end
})

V.HLToggle:AddColorPicker('OutlineColor', {
    Default = Color3.new(1, 0, 0),
    Title = 'Outline Color',
    Callback = function(color)
        Config.TargetHighlight.OutlineColor = color
    end
})

V.HLToggle:AddColorPicker('FillColor', {
    Default = Color3.new(1, 0, 0),
    Title = 'Fill Color',
    Callback = function(color)
        Config.TargetHighlight.FillColor = color
    end
})

V.VisBox:AddSlider('OutlineTransparency', {
    Text = 'Outline Transparency',
    Default = 0,
    Min = 0,
    Max = 1,
    Rounding = 2,
    Compact = false,
    Callback = function(v)
        Config.TargetHighlight.OutlineTransparency = v
    end
})

V.VisBox:AddSlider('FillTransparency', {
    Text = 'Fill Transparency',
    Default = 0.5,
    Min = 0,
    Max = 1,
    Rounding = 2,
    Compact = false,
    Callback = function(v)
        Config.TargetHighlight.FillTransparency = v
    end
})

local function AutoResetTarget()
    if not V.Target or not V.Target.player then return end
    
    if (Config.Aimbot.ResetKnocked and IsPlayerKO(V.Target.player)) or
       (Config.Aimbot.ResetGrabbed and IsPlayerGrabbed(V.Target.player)) or
       (Config.Aimbot.ResetDeath and (not V.Target.player.Character or not V.Target.player.Character:FindFirstChildOfClass('Humanoid') or V.Target.player.Character:FindFirstChildOfClass('Humanoid').Health <= 0)) then
        print('[ResetTarget] Сброс цели')
        V.Target = nil
    end
end

-----------------------
-- CONNECTIONS
-----------------------
V.RS.RenderStepped:Connect(function()
    AutoResetTarget()
    UpdateTargetHighlight()
end)
V.UIS.InputBegan:Connect(OnInputBegan)
V.Save:BuildConfigSection(Tabs.Config)
V.ThemeBox = Tabs.Config:AddLeftGroupbox('')
V.Theme:ApplyToGroupbox(V.ThemeBox)
V.Theme:LoadDefault()
V.Save:LoadAutoloadConfig()
